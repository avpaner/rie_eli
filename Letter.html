<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Love Letter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* --- Font Import for Handwriting and Inter --- */
        @import url('https://fonts.googleapis.com/css2?family=Cedarville+Cursive&family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght=400;700&display=swap');

        :root {
            --primary: #f8f8f8;
            --bg-color: #e0e0e0;
            --bg-envelope-color: #fafafa;
            --envelope-tab: #e8e8e8;
            --envelope-cover: #dcdcdc;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --txt-color: #333;
            --heart-color: #ff6b6b;
            /* Fire/Glow Colors */
            --fire-color-1: #ff7f00; /* Deep Orange */
            --fire-color-2: #ff4500; /* Orange Red */
        }
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* --- Background Image Styling --- */
            background: url('https://i.ibb.co/HTWbHfCj/edeebea7-e757-4d0e-9d95-e46c80173f9c.jpg') no-repeat center center fixed;
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', sans-serif; 
            min-height: 100vh;
            overflow: hidden; 
        }
        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
        }
        .envelope-wrapper {
            background: var(--bg-envelope-color);
            box-shadow: 0 5px 15px var(--shadow-color);
            z-index: 20; 
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        
        /* Envelope toss animation */
        .envelope-wrapper.toss {
            transform: translate(50vw, -150vh) scale(0.1) rotate(100deg);
            opacity: 0;
            transition: transform 1.5s ease-in, opacity 1s ease-in;
        }

        /* Basic Envelope Styles */
        .envelope-wrapper > .envelope {
            position: relative;
            width: 300px;
            height: 230px;
        }
        .envelope-wrapper > .envelope::before {
            content: "";
            position: absolute;
            top: 0;
            z-index: 2;
            border-top: 130px solid var(--envelope-tab);
            border-right: 150px solid transparent;
            border-left: 150px solid transparent;
            transform-origin: top;
            transition: transform 0.7s ease-in-out 0.7s;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .envelope-wrapper > .envelope::after {
            content: "";
            position: absolute;
            z-index: 2;
            width: 0;
            height: 0;
            border-top: 130px solid transparent;
            border-right: 150px solid var(--envelope-cover);
            border-bottom: 100px solid var(--envelope-cover);
            border-left: 150px solid var(--envelope-cover);
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        /* Heart Styles */
        .heart {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px; 
            height: 30px; 
            background: var(--heart-color);
            z-index: 4;
            transform: translate(-50%, -10%) rotate(45deg); 
            transition: transform 0.5s ease-in-out 1s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .heart:before, .heart:after {
            content: "";
            position: absolute;
            width: 30px; 
            height: 30px; 
            background-color: var(--heart-color);
            border-radius: 50%;
        }
        .heart:before { top: -15px; } 
        .heart:after { right: 15px; } 
        .heart-text {
            position: relative;
            z-index: 5;
            font-family: 'Inter', sans-serif;
            font-size: 7px; 
            font-weight: 400; 
            color: var(--primary); 
            transform: rotate(-45deg); 
            text-align: center;
            line-height: 1;
            letter-spacing: 0.5px;
        }
        
        .flap > .envelope::before {
            transform: rotateX(180deg);
            z-index: 0;
        }
        .flap > .heart {
            transform: rotate(90deg) scale(0);
            transition-delay: 0.4s;
        }

        /* Letter Animation & Contained Styles */
        .letter {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) scale(0.5);
            width: 54%;
            height: 80%;
            background: var(--primary);
            box-shadow: 0 0 5px var(--shadow-color);
            padding: 30px; 
            opacity: 0;
            z-index: 3;
            transition: all 1s ease-in-out;
            border-radius: 8px;
            overflow-y: hidden; 
        }
        
        @keyframes letter-out-and-fit {
            0% {
                bottom: 0;
                opacity: 1;
                transform: translateX(-50%) scale(1);
                width: 54%;
                height: 80%;
            }
            100% {
                bottom: auto;
                opacity: 1;
                transform: translate(-50%, -50%);
                width: 90vw; 
                height: 90vh; 
                position: fixed;
                left: 50%;
                top: 50%;
                overflow-y: auto; 
                z-index: 100;
                padding: 2rem;
            }
        }

        .letter.open {
            animation: letter-out-and-fit 3s forwards;
            animation-delay: 1.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .letter.close {
            animation: letter-in-and-fold 1.5s forwards; 
            transition: none; 
        }
        
        @keyframes letter-in-and-fold {
            0% {
                transform: translate(-50%, -50%);
                width: 90vw;
                height: 90vh;
                opacity: 1;
                position: fixed;
                left: 50%;
                top: 50%;
            }
            100% {
                transform: translateX(-50%) scale(0.5); 
                width: 54%;
                height: 80%;
                opacity: 0; 
                position: absolute;
                left: 50%;
                bottom: 0;
                top: auto;
                z-index: 3;
            }
        }

        /* Letter Content Styling */
        .letter-content {
            font-family: 'Cedarville Cursive', cursive; 
            color: var(--txt-color);
            font-size: clamp(24px, 4vw, 32px); 
            line-height: 1.8;
            white-space: pre-wrap; 
            text-align: left; 
        }
        @keyframes blink { 50% { opacity: 0; } }
        .typing-cursor {
            font-family: 'Cedarville+Cursive', cursive; 
            font-size: clamp(24px, 4vw, 32px);
            line-height: 1.8;
            display: inline-block;
            animation: blink 1s step-end infinite;
            vertical-align: top;
        }
        
        /* --- Message Footer (After Letter) --- */
        #message-footer {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            background: rgba(44, 62, 80, 0.95); 
            color: var(--primary);
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #message-footer.visible {
            opacity: 1;
            visibility: visible;
        }
        #footer-text-content {
            font-family: 'Cedarville Cursive', cursive;
            font-size: clamp(18px, 3vw, 24px);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        /* --- DIARY WRITING CANVAS (The element that burns) --- */
        #diary-paper {
            /* Requirement: White and Rounded, Center */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%; 
            max-width: 900px;
            height: 95vh; 
            max-height: 800px;
            background: #fff; /* Requirement: Plain white paper */
            color: var(--txt-color);
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            padding: 30px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            opacity: 1; 
            visibility: hidden; 
            transition: all 0.5s ease-in, opacity 4s ease-in; 
            z-index: 100; 
        }
        #diary-paper.visible {
            visibility: visible;
            transition: opacity 0.5s ease-in;
        }
        
        /* --- Burning Ritual Styles --- */
        @keyframes subtleShake {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            25% { transform: translate(-50.5%, -49.5%) scale(1.005); }
            50% { transform: translate(-49.5%, -50.5%) scale(1.005); }
            75% { transform: translate(-50.5%, -50.5%) scale(1.005); }
        }
        
        .burning-glow {
            box-shadow: 
                0 0 10px 5px rgba(255, 69, 0, 0.8), 
                0 0 50px 10px var(--fire-color-1), 
                0 0 100px 30px rgba(255, 165, 0, 0.4); 
            border: 4px solid var(--fire-color-2);
            filter: brightness(1.1) contrast(1.1);
            animation: subtleShake 0.5s infinite alternate;
            transition: all 0.5s ease-in-out;
        }
        
        /* Burning Disintegration Classes */
        .disintegrate-stage-1 { filter: grayscale(0.2) blur(0.2px); transform: translate(-50%, -50%) scale(0.98); opacity: 0.95; }
        .disintegrate-stage-2 { filter: grayscale(0.5) blur(0.5px); transform: translate(-50%, -50%) scale(0.95) rotate(0.5deg); opacity: 0.8; }
        .disintegrate-stage-3 { filter: grayscale(0.8) blur(1px) brightness(0.6); transform: translate(-50%, -50%) scale(0.90) rotate(-0.5deg); opacity: 0.6; }
        .disintegrate-final { transform: translate(-50%, -50%) scale(0.2) rotate(15deg); opacity: 0; transition: all 3s ease-in; }
        
        #fire-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; opacity: 0;
            transition: opacity 2s ease-in-out;
            border-radius: 8px;
            background: 
                radial-gradient(circle at 10% 10%, rgba(255, 100, 0, 0.5) 0%, transparent 40%),
                radial-gradient(circle at 90% 90%, rgba(255, 100, 0, 0.4) 0%, transparent 30%),
                radial-gradient(circle at 50% 100%, rgba(255, 200, 0, 0.6) 0%, transparent 25%);
            animation: flicker 0.1s infinite alternate;
        }
        .show-fire #fire-overlay { opacity: 0.8; }
        @keyframes flicker {
            0% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 0.85; transform: scale(1.005); }
            100% { opacity: 0.75; transform: scale(1); }
        }
        
        #diary-text-area.read-only .word.hidden {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-out; 
        }
        
        /* --- Diary Internal Layout --- */
        #close-diary-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            line-height: 1;
            color: #777;
            cursor: pointer;
            z-index: 10;
            padding: 5px;
        }

        #writing-pen {
            width: 60px; /* Requirement: Make the pen bigger */
            height: auto;
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            transition: top 0.3s ease-out;
            cursor: pointer; /* Requirement: Pen is always clickable for initial trigger */
            z-index: 1;
        }
        /* Pen Down (Initial/Disabled State) */
        #writing-pen:not(.active) {
            top: 35px; /* Slightly lower position when down/disabled */
        }
        /* Pen Lifted (Active/Typing State) */
        #writing-pen.active {
            top: 5px; /* Lifted position */
        }
        
        #pen-instruction {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            text-align: center;
            margin-top: 80px;
            transition: opacity 0.3s;
            color: #555;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
        }
        #pen-instruction.hidden {
            opacity: 0;
        }
        
        #diary-input, #text-content-wrapper {
            flex-grow: 1;
            margin-top: 100px;
            border: none;
            resize: none;
            font-family: 'Cedarville Cursive', cursive;
            font-size: clamp(18px, 3vw, 24px);
            line-height: 1.6;
            background: transparent;
            color: var(--txt-color);
            transition: opacity 0.3s;
            padding: 0;
            overflow-y: auto;
        }
        
        /* --- Thank You Modal Layout (Lighter/Hugs) --- */
        #thank-you-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 5;
            text-align: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0s linear 0.3s;
            max-width: 80%;
            /* Requirement: Use handwriting font */
            font-family: 'Cedarville Cursive', cursive; 
        }
        #thank-you-modal.visible {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.3s, visibility 0s linear 0s;
        }
        #modal-message {
            font-size: clamp(20px, 4vw, 28px);
            line-height: 1.5;
            margin-bottom: 2rem;
            color: #444;
        }
        #lighter-btn {
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            position: relative;
            display: inline-block; /* Show it for fading in */
            margin: 0 auto;
            transition: opacity 0.5s ease-in; /* For fading in */
            opacity: 0;
            pointer-events: none; /* Initially disabled until audio plays */
        }
        #lighter-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Lighter Icon Styling */
        .lighter-icon {
            font-size: 60px;
            color: #ff4500;
            transition: color 0.3s;
        }
        .lighter-icon:hover {
            color: #ff7f00;
        }
        
        @keyframes pulse { to { box-shadow: 0 0 25px var(--fire-color-1); } }
        
        /* --- Video Popup (Ritual) --- */
        #ritual-video-popup {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85); /* Dark overlay */
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 120; 
        }
        #ritual-video-popup.active {
            display: flex;
        }
        #ritual-video {
            max-width: 90%;
            max-height: 90%;
            border-radius: 12px;
            box-shadow: 0 0 50px rgba(255, 69, 0, 0.5);
        }
        
        /* --- Final Message Canvas --- */
        #final-message-canvas {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background: #fff; /* Requirement: White */
            padding: 30px;
            border-radius: 16px; /* Requirement: Rounded */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: opacity 1s ease-in-out;
        }
        #final-message-canvas.visible {
            opacity: 1;
            visibility: visible;
        }
        #final-text-content {
            font-family: 'Cedarville Cursive', cursive;
            font-size: clamp(20px, 4vw, 28px);
            line-height: 1.7;
            color: #2c3e50;
            white-space: pre-wrap;
        }
        /* Signature style */
        #final-text-content .signature {
            display: block;
            margin-top: 20px;
            font-size: clamp(24px, 5vw, 36px);
        }

        /* Mute Button Positioning */
        #mute-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            z-index: 150;
            transition: background 0.3s;
        }
        #mute-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

    </style>
</head>
<body>
    <div id="ritual-video-popup">
        <video id="ritual-video" src="video/breathing.mp4" muted playsinline></video>
    </div>
    
    <div id="final-message-canvas">
        <div id="final-text-content"></div>
    </div>

    <div class="container">
        <div class="envelope-wrapper">
            <div class="envelope">
                <div class="letter" id="the-letter">
                    
                    <div id="intro-content" class="letter-content"></div>

                    <button id="skip-btn" class="absolute bottom-4 right-4 text-sm text-gray-800 hover:text-black transition" style="display: none;">Skip Typing &raquo;</button>
                    
                    <div id="continue-button-wrapper" class="text-center mt-10">
                        <button id="continue-btn" disabled 
                                class="px-6 py-2 bg-white text-gray-800 border-2 border-gray-800 font-bold rounded-full opacity-0 transition shadow-md hover:bg-gray-100 pointer-events-none">
                            CONTINUE
                        </button>
                    </div>
                    
                </div>
            </div>
            <div class="heart">
                <span class="heart-text">OPEN ME</span>
            </div>
        </div>
    </div>
    
    <button id="mute-btn" title="Mute Sound">
        ðŸ”Š 
    </button>
    
    <div id="message-footer">
        <p id="footer-text-content"></p>
        
        <div id="final-button-wrapper">
            <button id="final-continue-btn" class="px-6 py-2 bg-red-500 text-white font-bold rounded-full shadow-lg hover:bg-red-600">OKIE DOKIE</button>
        </div>
    </div>

    <div id="diary-paper">
        
        <div id="fire-overlay"></div>
        
        <button id="close-diary-btn" title="Close/Minimize">
            &ndash; 
        </button>
        
        <div id="pen-container" class="absolute top-0 left-0 right-0">
            <img src="https://pngimg.com/uploads/pen/pen_PNG7402.png" alt="Pen" id="writing-pen" class="transition-all duration-300">
            <p id="pen-instruction">Click to write. After writing, click this pen again to finalize your message.</p>
        </div>

        <textarea id="diary-input" disabled placeholder="Your safe space is here... Dump all your thoughts and worries."></textarea>

        <div id="thank-you-modal">
            <p id="modal-message"></p> 
            
            <button id="lighter-btn" title="Click to start the burning">
                <i class="lighter-icon fas fa-fire-alt"></i>
                <p class="text-xs text-gray-600 mt-2">Click to Ignite</p>
            </button>
        </div>
        
        <div id="text-content-wrapper" style="display: none; flex-grow: 1; overflow-y: auto;">
            <div id="diary-text-area" class="read-only">
                </div>
        </div>
    </div>
    
    <script type="module">
        // Global variables provided by the Canvas environment for Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Ensure we import the necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Setup & Initialization ---
        let app, db, auth;
        let userId = 'anon';

        setLogLevel('Debug');

        async function initializeFirebase() {
            if (firebaseConfig) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    userId = auth.currentUser?.uid || crypto.randomUUID();
                } catch (e) {
                    console.error("Firebase Initialization or Auth Error:", e);
                }
            } else {
                console.warn("Firebase config missing. Running without persistence.");
            }
        }
        
        // --- Configuration ---
        // Requirement: New Apps Script URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyF0otTiTzwx3qQ_S1gW1KYsw91obRKeC3DZHtetGSzp_AoYdh3ZNhNdGKMnz4BkZHuqQ/exec'; 

        // --- Ritual Configuration (40 seconds total) ---
        const RITUAL_DURATION = 40000; 
        const STAGE_DURATION = RITUAL_DURATION / 3;
        const VIDEO_LOOP_COUNT = 3;
        
        // --- DOM Element References ---
        const envelope = document.querySelector('.envelope-wrapper');
        const letter = document.getElementById('the-letter');
        const introContentDiv = document.getElementById('intro-content');
        const continueBtn = document.getElementById('continue-btn'); 
        const skipBtn = document.getElementById('skip-btn'); 
        
        const footerDiv = document.getElementById('message-footer');
        const footerTextContent = document.getElementById('footer-text-content');
        const finalContinueBtn = document.getElementById('final-continue-btn'); 

        const diaryPaper = document.getElementById('diary-paper');
        const writingPen = document.getElementById('writing-pen');
        const penInstruction = document.getElementById('pen-instruction');
        const diaryInput = document.getElementById('diary-input');
        const closeDiaryBtn = document.getElementById('close-diary-btn');
        const thankYouModal = document.getElementById('thank-you-modal');
        const modalMessage = document.getElementById('modal-message');
        const muteBtn = document.getElementById('mute-btn'); 
        const lighterBtn = document.getElementById('lighter-btn');
        
        // Synchronized Ritual Elements
        const textContentWrapper = document.getElementById('text-content-wrapper');
        const diaryTextArea = document.getElementById('diary-text-area');
        const fireOverlay = document.getElementById('fire-overlay');
        
        // New Ritual/Post-Ritual Elements
        const ritualVideoPopup = document.getElementById('ritual-video-popup');
        const ritualVideo = document.getElementById('ritual-video');
        const finalMessageCanvas = document.getElementById('final-message-canvas');
        const finalTextContent = document.getElementById('final-text-content');


        // --- State Variables ---
        let isAnimating = false;
        let hasOpened = false;
        let isPenActive = false; 
        let typingTimerId = null; 
        let isMuted = false; 
        let typedContent = ""; 
        let ritualTimeoutId = null; 
        let videoLoopCounter = 0;
        
        // --- Audio and Content Setup ---
        // Placeholder media URLs - MUST BE REPLACED BY USER
        const TYPING_AUDIO_URL = 'audio/rie.mp3'; 
        const BG_AUDIO_URL = 'audio/Content 2.mp3'; 
        const MODAL_AUDIO_URL = 'audio/YUNN.mp3';
        const LIGHTER_AUDIO_URL = 'audio/Lighter.mp3'; 
        const ASH_AUDIO_URL = 'audio/Ash.mp3';
        const END_VIDEO_URL = 'video/End.mp4';
        
        // Audio elements
        const typingAudio = new Audio(TYPING_AUDIO_URL); 
        const bgAudio = new Audio(BG_AUDIO_URL); 
        const modalAudio = new Audio(MODAL_AUDIO_URL);
        const lighterAudio = new Audio(LIGHTER_AUDIO_URL); 
        const ashAudio = new Audio(ASH_AUDIO_URL); 
        
        typingAudio.loop = false; 
        bgAudio.loop = true; 
        modalAudio.loop = false; 
        lighterAudio.loop = false; 
        ashAudio.loop = false;

        const introContent = `To my very precious boy, Rie,

Since the first day na nagkausap tayo, sobra ko nang na-cherish bawat moment with you. Every word, every smile, every little silence natin, I do treasure it all. Alam kong may mga panahon na hindi tayo makakapag-usap palagi, kaya ginawa ko itong letter na para lang saâ€™yo, something na pwede mong balikan kapag kailangan mo ako. I dedicate this interactive letter to you, para sa mga oras na nalulungkot ka, napre-pressure ka, o kahit sa mga simpleng sandali na nami-miss mo ako.`;
        
        const footerMessage = `Alam ko na ang dami mong iniisip ngayon, kaya para kahit papaano gumaan ang pakiramdam mo at maibsan ang kirot sa puso mo, Iâ€™m giving you the pen and paper for you to write all of your pains and worries. This will be your temporary virtual diary, your safe space para mailabas lahat ng nasa pusoâ€™t isipan mo. Kaya feel free na sabihin lahat ng gusto mo ^^`;
        
        const modalContent = `Hugs to you, Rie. All of your feelings are valid. Ngayon, para kahit papaano gumaan ang bigat at sakit sa puso mo, letâ€™s burn all of this pain together. As the paper burns, follow my breathing patterns, slowly, gently, until you feel lighter.`;
        
        const finalMessageText = `Iâ€™m so proud of you for being this brave. Nandito lang ako palagi para saâ€™yo, no matter what. Kapag mabigat pa rin, message me or tawagan mo ako â€” hindi ka kailanman nag-iisa.

Lubos na nagmamahal saâ€™yo,
<span class="signature">Eli</span>`;
        
        // --- Core Logic Functions ---
        
        /**
         * Saves the diary entry to a Google Sheet via Apps Script and to Firestore.
         */
        async function saveToSheet(message) {
            if (!message) return;

            // 1. Save to Google Sheet via Apps Script
            if (APPS_SCRIPT_URL) {
                try {
                    // Apps Script handles the date/message column mapping (A: Date, B: Message)
                    await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: JSON.stringify({ message: message })
                    });
                    console.log("Sheet save request sent.");
                } catch (error) {
                    console.error("SHEET SAVE FAILED:", error);
                }
            }
            
            // 2. Log to Firestore
            if (db) {
                try {
                    const diaryRef = collection(db, `/artifacts/${appId}/users/${userId}/diary_entries`);
                    await setDoc(doc(diaryRef), {
                        timestamp: new Date().toISOString(),
                        content: message,
                        status: 'written_and_saved'
                    });
                } catch (error) {
                    console.error("Error logging diary entry to Firestore:", error);
                }
            }
        }
        
        function skipTyping() {
            if (typingTimerId !== null) {
                clearTimeout(typingTimerId);
                typingTimerId = null;
            }
            typingAudio.pause();
            typingAudio.currentTime = 0;
            introContentDiv.innerHTML = introContent; 
            
            // Ensure button appears when skipped
            continueBtn.style.opacity = '1';
            continueBtn.classList.remove('pointer-events-none'); 
            continueBtn.removeAttribute('disabled');
            
            skipBtn.style.display = 'none';
            isAnimating = false;
            hasOpened = true; 
        }

        function typeWriter(text, element, callback = () => {}) {
            let i = 0;
            element.innerHTML = ''; 
            const cursorHtml = '<span class="typing-cursor">|</span>'; 
            
            skipBtn.style.display = 'block';

            if (!isMuted) {
                typingAudio.play().catch(error => console.error("Autoplay prevented:", error));
            }

            function type() {
                if (i < text.length) {
                    const char = text.charAt(i);
                    element.innerHTML = text.substring(0, i + 1) + cursorHtml;
                    i++;
                    letter.scrollTop = letter.scrollHeight;
                    typingTimerId = setTimeout(type, 80); 
                } else {
                    typingAudio.pause();
                    typingAudio.currentTime = 0; 
                    element.innerHTML = text; 
                    skipBtn.style.display = 'none';
                    callback();
                }
            }
            type();
        }

        /**
         * Toggles the mute state for all audio elements.
         */
        function toggleMute() {
            isMuted = !isMuted;
            muteBtn.textContent = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';

            // Mute/Unmute all audio elements
            [typingAudio, bgAudio, modalAudio, lighterAudio, ashAudio, ritualVideo].forEach(el => {
                el.muted = isMuted;
            });

            if (!isMuted) {
                // Only try to resume audio if we were playing before mute or are in a state that requires it
                if (footerDiv.classList.contains('visible') || ritualVideoPopup.classList.contains('active')) {
                    bgAudio.play().catch(e => console.error("BGAudio resume failed:", e));
                }
            } else {
                 [bgAudio, modalAudio, lighterAudio, ashAudio].forEach(audio => audio.pause());
            }
        }
        
        /**
         * Opens the diary interface.
         */
        function activateDiaryWriting() {
            // Hide message footer and stop its audio
            footerDiv.classList.remove('visible');
            bgAudio.pause();
            bgAudio.currentTime = 0; 
            
            // Show diary paper (White and Rounded, Plain)
            diaryPaper.classList.add('visible'); 
            
            // Pen setup: Initially down, input disabled, waiting for first click
            isPenActive = false;
            writingPen.classList.remove('active');
            diaryInput.disabled = true;
            diaryInput.value = '';
            penInstruction.textContent = "Click to write. After writing, click this pen again to finalize your message.";
            penInstruction.classList.remove('hidden');

            // Hide read-only and modal
            textContentWrapper.style.display = 'none';
            thankYouModal.classList.remove('visible');
        }

        /**
         * Handles the pen click logic: Start typing -> Finalize/Show Modal
         */
        function handlePenClick() {
            if (!isPenActive) {
                // START TYPING
                isPenActive = true;
                writingPen.classList.add('active'); // Lift the pen
                diaryInput.disabled = false; // Enable typing
                diaryInput.focus();
                penInstruction.textContent = "Your thoughts are safe. Click the pen again when you are finished.";
                
                // Ensure read-only text is hidden when typing
                textContentWrapper.style.display = 'none';

            } else {
                // FINALIZE & SHOW MODAL
                const message = diaryInput.value.trim();
                if (message.length < 5) {
                    alert("Please write a bit more before finalizing your message.");
                    return;
                }

                // 1. Save and update state
                saveToSheet(message); 
                typedContent = message;
                isPenActive = false;
                diaryInput.disabled = true;
                writingPen.classList.remove('active'); // Pen down/finalized state
                penInstruction.classList.add('hidden'); // Hide instructions

                // 2. Prepare for Ritual View
                diaryInput.style.display = 'none'; // Hide textarea
                textContentWrapper.style.display = 'flex'; // Show read-only wrapper
                renderDiaryTextForRitual(typedContent); // Populate words for burning

                // 3. Show Modal
                showThankYouModal();
            }
        }
        
        /**
         * Shows the Thank You modal and plays the audio.
         */
        function showThankYouModal() {
            modalMessage.textContent = modalContent;
            thankYouModal.classList.add('visible');
            lighterBtn.classList.remove('visible'); // Hide lighter initially

            if (!isMuted) {
                modalAudio.play().catch(e => console.error("Modal audio failed:", e));
            }
            
            // Lighter appears after modal audio finishes (simulated 3s)
            setTimeout(() => {
                if (!isMuted) {
                    lighterAudio.play().catch(e => console.error("Lighter audio failed:", e));
                }
                lighterBtn.classList.add('visible'); // Lighter fades in
            }, 3000); 
        }

        /**
         * Prepares the typed text for word-by-word burning animation.
         */
        function renderDiaryTextForRitual(text) {
            diaryTextArea.innerHTML = text.split(/\s+/).map(word => 
                `<span class="word">${word}</span>`
            ).join(' ');
        }

        /**
         * Starts the Burning Ritual (video and paper effects).
         */
        function startBurningRitual() {
            // 1. Hide modal and prepare paper for burn
            thankYouModal.classList.remove('visible');
            diaryPaper.classList.add('show-fire', 'burning-glow');
            
            // 2. Start Video and Audio
            ritualVideo.src = 'video/breathing.mp4';
            ritualVideo.loop = true;
            ritualVideo.currentTime = 0;
            ritualVideo.muted = isMuted;
            ritualVideoPopup.classList.add('active');
            
            if (!isMuted) {
                ritualVideo.play().catch(e => console.error("Video autoplay failed:", e));
            }

            videoLoopCounter = 0;

            ritualVideo.onended = function() {
                videoLoopCounter++;
                if (videoLoopCounter < VIDEO_LOOP_COUNT) {
                    this.play();
                } else {
                    // This block handles the end of the breathing video loops
                    ritualVideo.src = END_VIDEO_URL;
                    ritualVideo.loop = false;
                    ritualVideo.currentTime = 0;
                    ritualVideo.play();
                }
            };
            
            // Initial ritual state updates
            performRitualStage(1);
            
            // Set up main ritual timeout for conclusion
            ritualTimeoutId = setTimeout(concludeRitual, RITUAL_DURATION);
        }

        /**
         * Progresses the visual burn effect and word disintegration.
         */
        function performRitualStage(stage) {
            if (stage === 1) {
                // Stage 1: Subtle burn glow begins
                setTimeout(() => {
                    performRitualStage(2);
                }, STAGE_DURATION);
            } else if (stage === 2) {
                // Stage 2: Disintegration and word fading starts
                diaryPaper.classList.add('disintegrate-stage-2');
                const words = document.querySelectorAll('.word');
                
                // Start word fading (simulated word loss)
                let wordIndex = 0;
                const wordFadeInterval = setInterval(() => {
                    if (wordIndex < words.length) {
                        // Hide roughly every 5th word for effect
                        if (wordIndex % 5 === 0) {
                             words[wordIndex].classList.add('hidden');
                        }
                        wordIndex++;
                    } else {
                        clearInterval(wordFadeInterval);
                    }
                }, 50);

                setTimeout(() => {
                    performRitualStage(3);
                }, STAGE_DURATION);
            } else if (stage === 3) {
                // Stage 3: Final stage, ash sound
                diaryPaper.classList.add('disintegrate-stage-3');
                if (!isMuted) {
                    ashAudio.play().catch(e => console.error("Ash audio failed:", e));
                }
            }
        }
        
        /**
         * Concludes the ritual and shows the final message.
         */
        function concludeRitual() {
            // 1. Final paper disappearance
            diaryPaper.classList.remove('show-fire', 'burning-glow', 'disintegrate-stage-2', 'disintegrate-stage-3');
            diaryPaper.classList.add('disintegrate-final');
            
            // 2. Hide video
            ritualVideo.pause();
            ritualVideoPopup.classList.remove('active');
            
            // 3. Show Final Message
            setTimeout(() => {
                finalTextContent.innerHTML = finalMessageText;
                finalMessageCanvas.classList.add('visible');
            }, 1000); // Wait for fade out
        }

        // --- Event Listeners ---
        
        // Envelope Open
        envelope.addEventListener('click', () => {
            if (isAnimating || hasOpened) return;
            isAnimating = true;
            envelope.classList.add('flap');

            // Wait for flap animation to complete before starting letter animation
            setTimeout(() => {
                letter.classList.add('open');
            }, 1000);

            // Wait for letter to settle (CSS animation delay + duration)
            setTimeout(() => {
                typeWriter(introContent, introContentDiv, () => {
                    // Callback: Typing finished
                    continueBtn.style.opacity = '1';
                    continueBtn.classList.remove('pointer-events-none');
                    continueBtn.removeAttribute('disabled');
                    isAnimating = false;
                    hasOpened = true; 
                });
            }, 4200); // 1s (flap) + 3.2s (letter-out-and-fit)
        });

        // Skip Typing
        skipBtn.addEventListener('click', skipTyping);

        // Continue to Footer Message
        continueBtn.addEventListener('click', () => {
            if (isAnimating) return;
            isAnimating = true;
            letter.classList.add('close');
            
            // Wait for letter to fold back in
            setTimeout(() => {
                envelope.classList.add('toss');
            }, 1500);

            // Wait for toss to finish before showing footer
            setTimeout(() => {
                footerTextContent.innerHTML = footerMessage;
                footerDiv.classList.add('visible');
                if (!isMuted) {
                    bgAudio.play().catch(e => console.error("BGAudio autoplay failed:", e));
                }
                isAnimating = false;
            }, 3000); 
        });

        // Continue from Footer to Diary
        finalContinueBtn.addEventListener('click', activateDiaryWriting);

        // Close Diary (Minimize)
        closeDiaryBtn.addEventListener('click', () => {
            diaryPaper.classList.remove('visible');
            // Re-show footer (optional, based on flow)
            footerDiv.classList.add('visible');
            if (!isMuted) {
                bgAudio.play().catch(e => console.error("BGAudio resume failed:", e));
            }
        });

        // Pen Click Logic (Requirement 3 implemented here)
        writingPen.addEventListener('click', handlePenClick);

        // Lighter Button (Starts the ritual)
        lighterBtn.addEventListener('click', startBurningRitual);

        // Mute Button
        muteBtn.addEventListener('click', toggleMute);

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });
    </script>
</body>
</html>